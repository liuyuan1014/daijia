# 代驾项目技术文档

## 1. 项目概述

### 1.1 项目简介
代驾项目（daijia）是一个基于Spring Cloud微服务架构的代驾服务平台，为用户提供专业的代驾服务。系统采用现代化的Java技术栈，支持司机端、客户端和管理端三端应用，具备完整的代驾业务流程。

### 1.2 技术特点
- **微服务架构**：采用Spring Cloud Alibaba技术栈
- **智能调度**：基于地理位置的司机派单算法
- **AI技术集成**：人脸识别、OCR识别确保安全
- **规则引擎**：使用Drools实现灵活的计费规则
- **支付集成**：深度集成微信支付和分账功能
- **多端支持**：司机端、客户端、管理端完整覆盖

## 2. 技术架构

### 2.1 核心技术栈

#### 基础框架
- **Spring Boot**: 3.0.5
- **Spring Cloud**: 2022.0.2  
- **Spring Cloud Alibaba**: 2022.0.0.0-RC2
- **Java版本**: 17
- **构建工具**: Maven

#### 微服务组件
- **服务注册发现**: Nacos Discovery
- **配置中心**: Nacos Config  
- **API网关**: Spring Cloud Gateway
- **服务调用**: OpenFeign + LoadBalancer
- **流量控制**: Alibaba Sentinel
- **分布式事务**: Seata 1.7.1

#### 数据存储
- **关系型数据库**: MySQL 8.0.30
- **ORM框架**: MyBatis-Plus 3.5.3.1
- **缓存**: Redis (Redisson 3.23.3)
- **文档数据库**: MongoDB
- **搜索引擎**: Elasticsearch

#### 第三方服务
- **微信支付**: wechatpay-java 0.2.11
- **微信小程序**: weixin-java-miniapp 4.5.5.B
- **腾讯云服务**: tencentcloud-sdk-java 3.1.322
- **对象存储**: 腾讯云COS、MinIO 8.5.2
- **任务调度**: XXL-Job 2.4.0
- **规则引擎**: Drools 8.41.0

### 2.2 项目模块结构

```
daijia-parent/
├── common/                    # 公共模块
│   ├── service-util/         # 服务工具包  
│   ├── common-util/          # 通用工具包
│   ├── rabbit-util/          # RabbitMQ工具
│   ├── spring-security/      # 安全框架
│   └── common-log/           # 日志组件
├── model/                    # 数据模型模块
├── service/                  # 业务服务模块
│   ├── service-driver/       # 司机服务
│   ├── service-customer/     # 客户服务  
│   ├── service-order/        # 订单服务
│   ├── service-payment/      # 支付服务
│   ├── service-map/          # 地图服务
│   ├── service-dispatch/     # 调度服务
│   ├── service-rules/        # 规则引擎服务
│   ├── service-coupon/       # 优惠券服务
│   ├── service-mq/           # 消息队列服务
│   └── service-system/       # 系统管理服务
├── service-client/           # 服务客户端模块
├── web/                      # Web应用模块
│   ├── web-driver/           # 司机端应用
│   ├── web-customer/         # 客户端应用
│   └── web-mgr/             # 管理后台
└── server-gateway/           # API网关
```

## 3. 核心业务模块详解

### 3.1 司机服务 (service-driver)

#### 启动类配置
```java
@SpringBootApplication
@EnableDiscoveryClient    // 启用服务发现
@EnableFeignClients      // 启用Feign客户端
public class ServiceDriverApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceDriverApplication.class, args);
    }
}
```

#### 核心功能
1. **司机认证管理**
   - 微信小程序登录集成
   - 身份证OCR识别
   - 驾驶证OCR识别
   - 人脸识别建模和验证

2. **司机信息管理**
   - 基本信息维护
   - 认证状态管理
   - 接单状态控制

#### 关键API接口

**司机认证相关**
```java
@Tag(name = "司机API接口管理")
@RestController
@RequestMapping(value="/driver/info")
public class DriverInfoController {
    
    @Operation(summary = "小程序授权登录")
    @GetMapping("/login/{code}")
    public Result<Long> login(@PathVariable String code);
    
    @Operation(summary = "获取司机认证信息")
    @GetMapping("/getDriverAuthInfo/{driverId}")
    public Result<DriverAuthInfoVo> getDriverAuthInfo(@PathVariable Long driverId);
    
    @Operation(summary = "创建司机人脸模型")
    @PostMapping("/creatDriverFaceModel")
    public Result<Boolean> creatDriverFaceModel(@RequestBody DriverFaceModelForm driverFaceModelForm);
    
    @Operation(summary = "验证司机人脸")
    @PostMapping("/verifyDriverFace")
    public Result<Boolean> verifyDriverFace(@RequestBody DriverFaceModelForm driverFaceModelForm);
}
```

#### 微信登录实现
```java
@Override
public Long login(String code) {
    try {
        // 根据code + 小程序id + 秘钥请求微信接口，返回openid
        WxMaJscode2SessionResult sessionInfo = 
                wxMaService.getUserService().getSessionInfo(code);
        String openid = sessionInfo.getOpenid();
        
        // 根据openid查询是否第一次登录
        LambdaQueryWrapper<DriverInfo> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(DriverInfo::getWxOpenId,openid);
        DriverInfo driverInfo = driverInfoMapper.selectOne(wrapper);
        
        if(driverInfo == null) {
            // 新司机注册：创建司机基本信息、设置信息、账户信息
            driverInfo = new DriverInfo();
            driverInfo.setNickname(String.valueOf(System.currentTimeMillis()));
            driverInfo.setWxOpenId(openid);
            driverInfoMapper.insert(driverInfo);
            
            // 初始化司机设置
            DriverSet driverSet = new DriverSet();
            driverSet.setDriverId(driverInfo.getId());
            driverSet.setAcceptDistance(new BigDecimal(SystemConstant.ACCEPT_DISTANCE));
            driverSetMapper.insert(driverSet);
            
            // 初始化司机账户
            DriverAccount driverAccount = new DriverAccount();
            driverAccount.setDriverId(driverInfo.getId());
            driverAccountMapper.insert(driverAccount);
        }
        
        // 记录登录日志
        DriverLoginLog driverLoginLog = new DriverLoginLog();
        driverLoginLog.setDriverId(driverInfo.getId());
        driverLoginLog.setMsg("小程序登录");
        driverLoginLogMapper.insert(driverLoginLog);
        
        return driverInfo.getId();
    } catch (WxErrorException e) {
        throw new GuiguException(ResultCodeEnum.DATA_ERROR);
    }
}
```

#### 人脸识别集成
使用腾讯云人脸识别服务：

```java
@Override
public Boolean creatDriverFaceModel(DriverFaceModelForm driverFaceModelForm) {
    // 获取司机信息
    DriverInfo driverInfo = driverInfoMapper.selectById(driverFaceModelForm.getDriverId());
    
    try {
        // 初始化腾讯云认证对象
        Credential cred = new Credential(tencentCloudProperties.getSecretId(),
                                        tencentCloudProperties.getSecretKey());
        IaiClient client = new IaiClient(cred, tencentCloudProperties.getRegion(),
                                         clientProfile);
        
        // 创建人脸模型请求
        CreatePersonRequest req = new CreatePersonRequest();
        req.setGroupId(tencentCloudProperties.getPersionGroupId());
        req.setPersonId(String.valueOf(driverInfo.getId()));
        req.setGender(Long.parseLong(driverInfo.getGender()));
        req.setPersonName(driverInfo.getName());
        req.setImage(driverFaceModelForm.getImageBase64());
        
        // 调用腾讯云API创建人脸模型
        CreatePersonResponse resp = client.CreatePerson(req);
        String faceId = resp.getFaceId();
        
        if(StringUtils.hasText(faceId)) {
            driverInfo.setFaceModelId(faceId);
            driverInfoMapper.updateById(driverInfo);
        }
        return true;
    } catch (TencentCloudSDKException e) {
        e.printStackTrace();
        return false;
    }
}
```

### 3.2 订单服务 (service-order)

#### 核心功能
1. **订单生命周期管理**
   - 订单创建和保存
   - 司机抢单机制
   - 订单状态流转
   - 订单计费和结算

2. **订单状态管理**
   - 等待接单
   - 司机接单
   - 司机到达
   - 开始代驾
   - 结束代驾
   - 订单支付

#### 关键API接口
```java
@Tag(name = "订单API接口管理")
@RestController
@RequestMapping(value="/order/info")
public class OrderInfoController {
    
    @Operation(summary = "保存订单信息")
    @PostMapping("/saveOrderInfo")
    public Result<Long> saveOrderInfo(@RequestBody OrderInfoForm orderInfoForm);
    
    @Operation(summary = "司机抢单")
    @GetMapping("/robNewOrder/{driverId}/{orderId}")
    public Result<Boolean> robNewOrder(@PathVariable Long driverId, @PathVariable Long orderId);
    
    @Operation(summary = "司机到达起始点")
    @GetMapping("/driverArriveStartLocation/{orderId}/{driverId}")
    public Result<Boolean> driverArriveStartLocation(@PathVariable Long orderId, @PathVariable Long driverId);
    
    @Operation(summary = "开始代驾服务")
    @PostMapping("/startDrive")
    public Result<Boolean> startDriver(@RequestBody StartDriveForm startDriveForm);
    
    @Operation(summary = "结束代驾服务更新订单账单")
    @PostMapping("/endDrive")
    public Result<Boolean> endDrive(@RequestBody UpdateOrderBillForm updateOrderBillForm);
}
```

### 3.3 支付服务 (service-payment)

#### 微信支付集成
使用微信支付V3版本API：

```java
@Service
public class WxPayServiceImpl implements WxPayService {
    
    @Override
    public WxPrepayVo createWxPayment(PaymentInfoForm paymentInfoForm) {
        try {
            // 1. 添加支付记录
            PaymentInfo paymentInfo = new PaymentInfo();
            BeanUtils.copyProperties(paymentInfoForm, paymentInfo);
            paymentInfo.setPaymentStatus(0);
            paymentInfoMapper.insert(paymentInfo);
            
            // 2. 创建微信支付对象
            JsapiServiceExtension service = 
                new JsapiServiceExtension.Builder().config(rsaAutoCertificateConfig).build();
            
            // 3. 封装支付请求参数
            PrepayRequest request = new PrepayRequest();
            Amount amount = new Amount();
            amount.setTotal(1); // 测试金额1分钱
            request.setAmount(amount);
            request.setAppid(wxPayV3Properties.getAppid());
            request.setMchid(wxPayV3Properties.getMerchantId());
            request.setDescription(paymentInfo.getContent());
            request.setNotifyUrl(wxPayV3Properties.getNotifyUrl());
            request.setOutTradeNo(paymentInfo.getOrderNo());
            
            // 设置支付用户
            Payer payer = new Payer();
            payer.setOpenid(paymentInfoForm.getCustomerOpenId());
            request.setPayer(payer);
            
            // 启用分账
            SettleInfo settleInfo = new SettleInfo();
            settleInfo.setProfitSharing(true);
            request.setSettleInfo(settleInfo);
            
            // 4. 调用微信支付API
            PrepayWithRequestPaymentResponse response = service.prepayWithRequestPayment(request);
            
            // 5. 封装返回结果
            WxPrepayVo wxPrepayVo = new WxPrepayVo();
            BeanUtils.copyProperties(response, wxPrepayVo);
            return wxPrepayVo;
        } catch (Exception e) {
            throw new GuiguException(ResultCodeEnum.DATA_ERROR);
        }
    }
}
```

#### 支付回调处理
```java
@Override
public void wxnotify(HttpServletRequest request) {
    // 1. 获取回调通知参数
    String wechatPaySerial = request.getHeader("Wechatpay-Serial");
    String nonce = request.getHeader("Wechatpay-Nonce");
    String timestamp = request.getHeader("Wechatpay-Timestamp");
    String signature = request.getHeader("Wechatpay-Signature");
    String requestBody = RequestUtils.readData(request);
    
    // 2. 构造请求参数对象
    RequestParam requestParam = new RequestParam.Builder()
            .serialNumber(wechatPaySerial)
            .nonce(nonce)
            .signature(signature)
            .timestamp(timestamp)
            .body(requestBody)
            .build();
    
    // 3. 验签解密
    NotificationParser parser = new NotificationParser(rsaAutoCertificateConfig);
    Transaction transaction = parser.parse(requestParam, Transaction.class);
    
    if(null != transaction && transaction.getTradeState() == Transaction.TradeStateEnum.SUCCESS) {
        // 4. 处理支付成功逻辑
        this.handlePayment(transaction);
    }
}

// 支付成功后续处理
private void handlePayment(Transaction transaction) {
    // 1. 更新支付记录状态
    String orderNo = transaction.getOutTradeNo();
    LambdaQueryWrapper<PaymentInfo> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(PaymentInfo::getOrderNo, orderNo);
    PaymentInfo paymentInfo = paymentInfoMapper.selectOne(wrapper);
    
    if(paymentInfo.getPaymentStatus() == 1) {
        return; // 已支付，避免重复处理
    }
    
    paymentInfo.setPaymentStatus(1);
    paymentInfo.setTransactionId(transaction.getTransactionId());
    paymentInfo.setCallbackTime(new Date());
    paymentInfoMapper.updateById(paymentInfo);
    
    // 2. 发送MQ消息进行后续业务处理
    rabbitService.sendMessage(MqConst.EXCHANGE_ORDER,
            MqConst.ROUTING_PAY_SUCCESS, orderNo);
}
```

### 3.4 规则引擎服务 (service-rules)

#### Drools规则引擎集成
使用Drools实现灵活的计费规则：

```java
@Service
public class FeeRuleServiceImpl implements FeeRuleService {
    
    @Autowired
    private KieContainer kieContainer;
    
    @Override
    public FeeRuleResponseVo calculateOrderFee(FeeRuleRequestForm calculateOrderFeeForm) {
        // 封装输入对象
        FeeRuleRequest feeRuleRequest = new FeeRuleRequest();
        feeRuleRequest.setDistance(calculateOrderFeeForm.getDistance());
        Date startTime = calculateOrderFeeForm.getStartTime();
        feeRuleRequest.setStartTime(new DateTime(startTime).toString("HH:mm:ss"));
        feeRuleRequest.setWaitMinute(calculateOrderFeeForm.getWaitMinute());
        
        // 创建Drools会话
        KieSession kieSession = kieContainer.newKieSession();
        
        // 封装返回对象
        FeeRuleResponse feeRuleResponse = new FeeRuleResponse();
        kieSession.setGlobal("feeRuleResponse", feeRuleResponse);
        
        // 插入事实并执行规则
        kieSession.insert(feeRuleRequest);
        kieSession.fireAllRules();
        kieSession.dispose();
        
        // 封装返回结果
        FeeRuleResponseVo feeRuleResponseVo = new FeeRuleResponseVo();
        BeanUtils.copyProperties(feeRuleResponse, feeRuleResponseVo);
        return feeRuleResponseVo;
    }
}
```

### 3.5 客户端Web层 (web-customer)

#### 客户端订单控制器
```java
@Tag(name = "订单API接口管理")
@RestController
@RequestMapping("/order")
public class OrderController {
    
    @Operation(summary = "预估订单数据")
    @GuiguLogin
    @PostMapping("/expectOrder")
    public Result<ExpectOrderVo> expectOrder(@RequestBody ExpectOrderForm expectOrderForm) {
        return Result.ok(orderService.expectOrder(expectOrderForm));
    }
    
    @Operation(summary = "乘客下单")
    @GuiguLogin
    @PostMapping("/submitOrder")
    public Result<Long> submitOrder(@RequestBody SubmitOrderForm submitOrderForm) {
        submitOrderForm.setCustomerId(AuthContextHolder.getUserId());
        return Result.ok(orderService.submitOrder(submitOrderForm));
    }
    
    @Operation(summary = "创建微信支付")
    @GuiguLogin
    @PostMapping("/createWxPayment")
    public Result<WxPrepayVo> createWxPayment(@RequestBody CreateWxPaymentForm createWxPaymentForm) {
        Long customerId = AuthContextHolder.getUserId();
        createWxPaymentForm.setCustomerId(customerId);
        return Result.ok(orderService.createWxPayment(createWxPaymentForm));
    }
}
```

## 4. 数据模型设计

### 4.1 司机相关实体

#### DriverInfo - 司机基本信息
```java
@Data
@Schema(description = "DriverInfo")
@TableName("driver_info")
public class DriverInfo extends BaseEntity {
    
    @Schema(description = "微信openId")
    @TableField("wx_open_id")
    private String wxOpenId;
    
    @Schema(description = "昵称")
    @TableField("nickname")
    private String nickname;
    
    @Schema(description = "头像")
    @TableField("avatar_url")
    private String avatarUrl;
    
    @Schema(description = "电话")
    @TableField("phone")
    private String phone;
    
    @Schema(description = "姓名")
    @TableField("name")
    private String name;
    
    @Schema(description = "性别")
    @TableField("gender")
    private String gender;
    
    @Schema(description = "身份证号码")
    @TableField("idcard_no")
    private String idcardNo;
    
    @Schema(description = "驾驶证证件号")
    @TableField("driver_license_no")
    private String driverLicenseNo;
    
    @Schema(description = "腾讯云人脸模型id")
    @TableField("face_model_id")
    private String faceModelId;
    
    @Schema(description = "认证状态")
    @TableField("auth_status")
    private Integer authStatus;
    
    // ... 其他字段
}
```

#### DriverSet - 司机设置信息
```java
@Data
@TableName("driver_set")
public class DriverSet extends BaseEntity {
    
    @Schema(description = "司机id")
    @TableField("driver_id")
    private Long driverId;
    
    @Schema(description = "接单里程设置")
    @TableField("order_distance")
    private BigDecimal orderDistance;
    
    @Schema(description = "接单范围")
    @TableField("accept_distance")
    private BigDecimal acceptDistance;
    
    @Schema(description = "是否自动接单")
    @TableField("is_auto_accept")
    private Integer isAutoAccept;
    
    @Schema(description = "服务状态")
    @TableField("service_status")
    private Integer serviceStatus;
}
```

### 4.2 订单相关实体

#### OrderInfo - 订单基本信息
```java
@Data
@TableName("order_info")
public class OrderInfo extends BaseEntity {
    
    @Schema(description = "客户ID")
    @TableField("customer_id")
    private Long customerId;
    
    @Schema(description = "司机ID")
    @TableField("driver_id")
    private Long driverId;
    
    @Schema(description = "订单号")
    @TableField("order_no")
    private String orderNo;
    
    @Schema(description = "起始地点")
    @TableField("start_location")
    private String startLocation;
    
    @Schema(description = "结束地点")
    @TableField("end_location")
    private String endLocation;
    
    @Schema(description = "预估里程")
    @TableField("expect_distance")
    private BigDecimal expectDistance;
    
    @Schema(description = "实际里程")
    @TableField("real_distance")
    private BigDecimal realDistance;
    
    @Schema(description = "预估金额")
    @TableField("expect_amount")
    private BigDecimal expectAmount;
    
    @Schema(description = "实际金额")
    @TableField("real_amount")
    private BigDecimal realAmount;
    
    @Schema(description = "订单状态")
    @TableField("status")
    private Integer status;
}
```

## 5. 微服务配置

### 5.1 Nacos配置
每个服务的bootstrap.properties配置：

```properties
# 服务名称
spring.application.name=service-driver
# 环境配置
spring.profiles.active=dev
# 允许Bean定义覆盖
spring.main.allow-bean-definition-overriding=true

# Nacos服务发现配置
spring.cloud.nacos.discovery.server-addr=192.168.184.128:8848

# Nacos配置中心
spring.cloud.nacos.config.server-addr=192.168.184.128:8848
spring.cloud.nacos.config.prefix=${spring.application.name}
spring.cloud.nacos.config.file-extension=yaml
spring.cloud.nacos.config.shared-configs[0].data-id=common-account.yaml

# Seata分布式事务配置（可选）
#seata.tx-service-group=tingshu-tx-group
#seata.service.vgroup-mapping.tingshu-tx-group=default
#seata.service.grouplist.default=127.0.0.1:8091
```

### 5.2 API网关配置

#### 网关过滤器
```java
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 统一处理认证和授权逻辑
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return 0;
    }
}
```

### 5.3 API文档配置

#### Knife4j配置
```java
@Configuration
public class Knife4jConfig {
    
    @Bean
    public GroupedOpenApi webApi() {
        return GroupedOpenApi.builder()
                .group("web-api")
                .pathsToMatch("/**")
                .build();
    }
    
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("代驾API接口文档")
                        .version("1.0")
                        .description("代驾API接口文档")
                        .contact(new Contact().name("qy")));
    }
}
```

## 6. 核心业务流程

### 6.1 司机注册认证流程

1. **微信小程序登录**
   - 获取微信授权code
   - 调用微信API获取openId
   - 创建或查询司机信息

2. **身份认证**
   - 上传身份证正反面照片
   - OCR识别身份证信息
   - 上传驾驶证照片
   - OCR识别驾驶证信息

3. **人脸识别建模**
   - 上传人脸照片
   - 调用腾讯云人脸识别API
   - 创建人脸模型并保存faceModelId

4. **每日人脸验证**
   - 司机每日首次接单前需要人脸验证
   - 调用腾讯云人脸比对API
   - 通过静态活体检测
   - 记录验证结果

### 6.2 订单业务流程

1. **客户下单**
   - 选择起点和终点
   - 预估费用和时间
   - 提交订单信息

2. **司机派单**
   - 基于地理位置查找附近司机
   - 智能派单算法
   - 司机抢单机制

3. **服务执行**
   - 司机接单
   - 司机到达起点
   - 开始代驾服务
   - 实时位置跟踪
   - 结束服务

4. **费用结算**
   - 根据实际里程和时间计算费用
   - 使用Drools规则引擎计费
   - 生成订单账单

5. **支付流程**
   - 创建微信支付订单
   - 客户支付
   - 支付回调处理
   - 分账给司机

### 6.3 支付分账流程

1. **支付创建**
   - 客户发起支付请求
   - 创建微信支付订单
   - 启用分账标识

2. **支付成功处理**
   - 接收微信支付回调
   - 验签和解密
   - 更新支付状态
   - 发送MQ消息

3. **分账处理**
   - 计算司机收入
   - 计算平台抽成
   - 系统奖励发放
   - 更新司机账户

## 7. 技术亮点

### 7.1 AI技术集成

#### 腾讯云人脸识别
- **人脸建模**：为每个司机创建唯一的人脸模型
- **人脸验证**：每日首次接单前进行人脸比对
- **活体检测**：防止照片欺骗，确保真人验证

#### OCR识别技术
- **身份证OCR**：自动识别身份证信息
- **驾驶证OCR**：自动识别驾驶证信息
- **提高效率**：减少手动输入，提升用户体验

### 7.2 规则引擎应用

#### Drools规则引擎
- **灵活计费**：支持复杂的计费规则配置
- **动态调整**：无需重启服务即可调整规则
- **业务分离**：业务规则与代码逻辑分离

#### 计费规则示例
- 基础费用 + 里程费用 + 时长费用
- 夜间加价、节假日加价
- 等待时间费用
- 高峰期动态定价

### 7.3 微服务架构优势

#### 服务拆分
- **按业务域拆分**：司机、客户、订单、支付等独立服务
- **数据隔离**：每个服务独立数据库
- **技术栈灵活**：不同服务可选择不同技术

#### 服务治理
- **服务发现**：Nacos自动服务注册发现
- **配置管理**：集中化配置管理
- **流量控制**：Sentinel限流熔断
- **链路追踪**：分布式链路监控

### 7.4 支付安全保障

#### 微信支付V3
- **RSA加密**：使用RSA2048位加密算法
- **API证书**：自动证书配置管理
- **签名验证**：请求和回调签名验证
- **分账功能**：支持资金分账到司机账户

#### 支付流程安全
- **幂等性处理**：防止重复支付
- **状态机控制**：严格的订单状态流转
- **异步处理**：MQ异步处理支付结果

## 8. 部署运维

### 8.1 环境要求

#### 基础环境
- **JDK**: 17+
- **Maven**: 3.6+
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **Nacos**: 2.x

#### 中间件服务
- **RabbitMQ**: 3.8+
- **MongoDB**: 4.4+
- **Elasticsearch**: 7.x
- **XXL-Job**: 2.4.0

### 8.2 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Client Apps   │    │   Client Apps   │    │   Admin Web     │
│  (Customer)     │    │   (Driver)      │    │   (Management)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │  API Gateway    │
                    │  (Load Balance) │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Service Cluster │    │ Service Cluster │    │ Service Cluster │
│   (Driver)      │    │   (Order)       │    │   (Payment)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Data Layer    │
                    │ MySQL/Redis/MQ  │
                    └─────────────────┘
```

### 8.3 配置管理

#### Nacos配置示例
```yaml
# common-account.yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/daijia_driver?characterEncoding=utf-8&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=GMT%2B8
    username: root
    password: 123456
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 1800000
      password:
      jedis:
        pool:
          max-active: 20
          max-wait: -1
          min-idle: 0
          max-idle: 8

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-field: isDeleted
      logic-delete-value: 1
      logic-not-delete-value: 0

# 腾讯云配置
tencent:
  cloud:
    secretId: your_secret_id
    secretKey: your_secret_key
    region: ap-beijing
    personGroupId: your_group_id

# 微信配置
wx:
  miniapp:
    appid: your_appid
    secret: your_secret
```

### 8.4 监控告警

#### 应用监控
- **Spring Boot Actuator**：健康检查端点
- **Micrometer**：应用指标采集
- **Prometheus**：指标监控
- **Grafana**：可视化监控面板

#### 日志管理
- **ELK Stack**：日志收集分析
- **分布式链路追踪**：Sleuth + Zipkin
- **统一日志格式**：JSON格式日志输出

## 9. API接口文档

### 9.1 司机端接口

#### 认证相关
```http
POST /driver/info/login/{code}
# 司机微信登录

GET /driver/info/getDriverAuthInfo/{driverId}
# 获取司机认证信息

POST /driver/info/creatDriverFaceModel
# 创建司机人脸模型

POST /driver/info/verifyDriverFace
# 验证司机人脸
```

#### 订单相关
```http
GET /order/info/robNewOrder/{driverId}/{orderId}
# 司机抢单

GET /order/info/driverArriveStartLocation/{orderId}/{driverId}
# 司机到达起始点

POST /order/info/startDrive
# 开始代驾服务

POST /order/info/endDrive
# 结束代驾服务
```

### 9.2 客户端接口

#### 订单相关
```http
POST /order/expectOrder
# 预估订单费用

POST /order/submitOrder
# 客户下单

GET /order/getOrderStatus/{orderId}
# 查询订单状态

POST /order/createWxPayment
# 创建微信支付
```

#### 支付相关
```http
GET /order/queryPayStatus/{orderNo}
# 查询支付状态

GET /order/findCustomerOrderPage/{page}/{limit}
# 获取客户订单列表
```

### 9.3 管理端接口

#### 系统管理
```http
POST /admin/system/login
# 管理员登录

GET /admin/system/getInfo
# 获取管理员信息

GET /admin/driver/list
# 司机列表管理

GET /admin/order/list
# 订单列表管理
```

## 10. 数据库设计

### 10.1 司机相关表

#### driver_info - 司机信息表
```sql
CREATE TABLE `driver_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `wx_open_id` varchar(255) DEFAULT NULL COMMENT '微信openId',
  `nickname` varchar(255) DEFAULT NULL COMMENT '昵称',
  `avatar_url` varchar(255) DEFAULT NULL COMMENT '头像',
  `phone` varchar(11) DEFAULT NULL COMMENT '电话',
  `name` varchar(255) DEFAULT NULL COMMENT '姓名',
  `gender` varchar(10) DEFAULT NULL COMMENT '性别',
  `birthday` date DEFAULT NULL COMMENT '生日',
  `idcard_no` varchar(18) DEFAULT NULL COMMENT '身份证号',
  `idcard_address` varchar(255) DEFAULT NULL COMMENT '身份证地址',
  `idcard_expire` date DEFAULT NULL COMMENT '身份证有效期',
  `idcard_front_url` varchar(255) DEFAULT NULL COMMENT '身份证正面',
  `idcard_back_url` varchar(255) DEFAULT NULL COMMENT '身份证背面',
  `idcard_hand_url` varchar(255) DEFAULT NULL COMMENT '手持身份证',
  `driver_license_class` varchar(10) DEFAULT NULL COMMENT '准驾车型',
  `driver_license_no` varchar(255) DEFAULT NULL COMMENT '驾驶证证件号',
  `driver_license_expire` date DEFAULT NULL COMMENT '驾驶证有效期',
  `driver_license_issue_date` date DEFAULT NULL COMMENT '驾驶证初次领证日期',
  `driver_license_front_url` varchar(255) DEFAULT NULL COMMENT '驾驶证正面',
  `driver_license_back_url` varchar(255) DEFAULT NULL COMMENT '驾驶证背面',
  `driver_license_hand_url` varchar(255) DEFAULT NULL COMMENT '手持驾驶证',
  `face_model_id` varchar(255) DEFAULT NULL COMMENT '腾讯云人脸模型id',
  `auth_status` int DEFAULT '0' COMMENT '认证状态',
  `status` int DEFAULT '1' COMMENT '状态 1正常 2禁用',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_wx_open_id` (`wx_open_id`)
) ENGINE=InnoDB COMMENT='司机信息表';
```

#### driver_set - 司机设置表
```sql
CREATE TABLE `driver_set` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `driver_id` bigint NOT NULL COMMENT '司机id',
  `order_distance` decimal(10,2) DEFAULT '0.00' COMMENT '接单里程设置',
  `accept_distance` decimal(10,2) DEFAULT '5.00' COMMENT '接单范围',
  `is_auto_accept` tinyint DEFAULT '0' COMMENT '是否自动接单',
  `service_status` tinyint DEFAULT '0' COMMENT '服务状态 0停止 1服务中',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_driver_id` (`driver_id`)
) ENGINE=InnoDB COMMENT='司机设置表';
```

### 10.2 订单相关表

#### order_info - 订单信息表
```sql
CREATE TABLE `order_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `customer_id` bigint NOT NULL COMMENT '客户ID',
  `driver_id` bigint DEFAULT NULL COMMENT '司机ID',
  `order_no` varchar(50) NOT NULL COMMENT '订单号',
  `start_location` varchar(200) NOT NULL COMMENT '起始地点',
  `start_point_longitude` decimal(10,7) NOT NULL COMMENT '起始点经度',
  `start_point_latitude` decimal(10,7) NOT NULL COMMENT '起始点纬度',
  `end_location` varchar(200) NOT NULL COMMENT '结束地点',
  `end_point_longitude` decimal(10,7) NOT NULL COMMENT '结束点经度',
  `end_point_latitude` decimal(10,7) NOT NULL COMMENT '结束点纬度',
  `expect_distance` decimal(10,2) DEFAULT NULL COMMENT '预估里程',
  `real_distance` decimal(10,2) DEFAULT NULL COMMENT '实际里程',
  `expect_amount` decimal(10,2) DEFAULT NULL COMMENT '预估金额',
  `real_amount` decimal(10,2) DEFAULT NULL COMMENT '实际金额',
  `favour_fee` decimal(10,2) DEFAULT '0.00' COMMENT '顾客好处费',
  `status` int NOT NULL DEFAULT '1' COMMENT '订单状态',
  `accept_time` datetime DEFAULT NULL COMMENT '接单时间',
  `arrive_time` datetime DEFAULT NULL COMMENT '司机到达时间',
  `start_service_time` datetime DEFAULT NULL COMMENT '开始服务时间',
  `end_service_time` datetime DEFAULT NULL COMMENT '结束服务时间',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_driver_id` (`driver_id`)
) ENGINE=InnoDB COMMENT='订单信息表';
```

### 10.3 支付相关表

#### payment_info - 支付信息表
```sql
CREATE TABLE `payment_info` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `customer_open_id` varchar(255) DEFAULT NULL COMMENT '客户微信openId',
  `order_no` varchar(50) NOT NULL COMMENT '订单号',
  `payment_type` tinyint NOT NULL COMMENT '付款类型',
  `trade_type` varchar(20) NOT NULL COMMENT '交易类型',
  `trade_no` varchar(50) DEFAULT NULL COMMENT '交易编号',
  `payment_status` tinyint NOT NULL DEFAULT '0' COMMENT '支付状态',
  `content` varchar(500) DEFAULT NULL COMMENT '支付内容',
  `amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '支付金额',
  `transaction_id` varchar(50) DEFAULT NULL COMMENT '微信交易号',
  `callback_time` datetime DEFAULT NULL COMMENT '回调时间',
  `callback_content` text COMMENT '回调信息',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`)
) ENGINE=InnoDB COMMENT='支付信息表';
```

## 11. 总结

### 11.1 项目特色

1. **完整的业务闭环**
   - 从司机注册到订单完成的完整业务流程
   - 支持多角色：司机、客户、管理员

2. **先进的技术栈**
   - Spring Cloud Alibaba微服务架构
   - AI技术深度集成（人脸识别、OCR）
   - 规则引擎实现灵活业务配置

3. **安全可靠**
   - 多重身份验证机制
   - 微信支付安全保障
   - 分布式事务确保数据一致性

4. **高性能架构**
   - 微服务独立部署扩展
   - Redis缓存提升性能
   - MQ异步处理提高响应速度

### 11.2 技术价值

1. **微服务最佳实践**
   - 展示了完整的微服务架构设计
   - 服务拆分和治理的典型案例
   - 分布式系统的工程实践

2. **AI技术应用**
   - 人脸识别在业务中的实际应用
   - OCR技术提升用户体验
   - 智能化身份验证流程

3. **支付系统集成**
   - 微信支付V3 API完整实现
   - 支付安全和分账功能
   - 异步支付处理机制

4. **规则引擎实践**
   - Drools规则引擎的实际应用
   - 业务规则与代码的分离
   - 动态计费策略实现

### 11.3 学习价值

1. **技术栈学习**
   - Spring Cloud微服务生态
   - 分布式系统设计理念
   - 现代Java开发实践

2. **业务理解**
   - 互联网出行业务模式
   - 代驾行业核心流程
   - 多端应用协同设计

3. **工程实践**
   - 大型项目架构设计
   - 第三方服务集成
   - 数据库设计规范

### 11.4 扩展方向

1. **技术优化**
   - 引入容器化部署（Docker + Kubernetes）
   - 服务网格技术（Istio）
   - 更完善的监控体系

2. **业务扩展**
   - 增加车辆管理模块
   - 完善评价系统
   - 添加客服系统

3. **性能提升**
   - 数据库读写分离
   - 缓存策略优化
   - CDN加速静态资源

---

**文档版本**: v1.0  
**最后更新**: 2025年7月22日  
**作者**: 基于daijia项目代码分析生成

本文档基于实际项目代码进行分析编写，详细描述了代驾项目的技术架构、核心功能实现、业务流程等各个方面，为理解和学习微服务架构提供了完整的参考案例。
